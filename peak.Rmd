---
title: "Peak detection"
author: "Mathieu Tiret & Pascal Milesi"
date: "19/03/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# loading libraries. --------------------------------------
library(data.table)
library(dplyr)
library(ggplot2)
library(tidyverse)
require(qvalue)

# loading datasets. ---------------------------------------
setwd( "certain_path" )
env  = read.table( "name.env.txt", header = F )
gwas = fread( file.choose() ) %>% as_tibble()
list.sign = read.table( file.choose(), header = T ) # list of significant SNPs full dataset. 

# checking. -----------------------------------------------
head( gwas )

# declaring variables. ------------------------------------
vars = 3
dataf2 = 
  gwas %>% 
  mutate( Scaff = Scaffold, Pos = 1:n(), ID = V1 ) %>% 
  select( Scaff, Pos, ID, LG, all_of(vars) )

slw.size       = 300
smooth.intens  = 0.90
extens         = "pcaAdapt"
type           = "BF" #"BF" # Pval
proba          = ifelse( type == "BF", 0.95, 0.95 ) # cut-off qvalue 0.1

iter    = 100
# marker  = nrow(gwas)
# sortie  = matrix( NA, length(vars), 1 )
# sortie2 = matrix( NA, nrow(dataf2), length(vars) )
liss    = matrix( NA, nrow(dataf2), length(vars) )

signals = list() 
length(signals) = length(vars)

```




## Peak (random)

```{r}
## helping functions. -------------------------------------
computing.profile = function( y, dens.cut )
{
  profile = y > dens.cut
  profile[is.na(profile)] = 0 
  counter = profile[slw.size:length(profile)] - 
    c(0, profile[1:(length(profile)-slw.size)])
  initial.sum = sum( profile[1:(slw.size-1)] )
  
  return( c( rep(NA, slw.size-1), initial.sum + cumsum(counter) ) )
}

randomization = function( .data, iter, dens.cut )
{
  replicate( 
    iter, 
    .data$y %>% sample %>% 
      computing.profile( dens.cut ) %>% max( na.rm = T )
    )
}

## peak detection. ----------------------------------------
for( var in length(vars) )
{
  # loading data. -------------------------------
  varname = names(dataf2)[4+var]
  dataf = 
    dataf2 %>% 
    rename( y = !!varname ) %>% 
    mutate(
      y = case_when( type == "BF" ~ log10(y),
                     type == "Pval" ~ -log10(y) )
    )
  
  dens.cut = case_when(
    type == "BF"   ~ quantile( dataf$y, p = proba ),
    type == "Pval" ~ quantile( dataf$y, p = proba )
  )
  
  cut.quantile = dataf %>% randomization(iter, dens.cut) %>% max
  
  # computing the density. ----------------------
  dataf = 
    dataf %>% 
    group_by(LG) %>% 
    mutate(
      avg    = computing.profile( y, dens.cut ),
      smooth = ifelse( avg < quantile( avg, p = smooth.intens, na.rm = T ),
                       0, avg )
    ) %>% 
    ungroup
  
  # outputting. ---------------------------------
  # smoothed peaks. 
  liss[, var] = dataf %>% pull(smooth)
  
  # positions of the peaks. 
  .signals  = dataf %>% filter( avg > cut.quantile ) %>% pull(Pos)
  .dsignals = diff(.signals)
  
  impl.signals = NULL
  i = 1
  while( i < length(.signals) )
  {
    j = i
    # strictly lower to avoid inter LG peaks. 
    while( j < length(.dsignals) && .dsignals[j] < slw.size ) j = j + 1
    
    impl.signals = 
      c(impl.signals, mean(.signals[i:(j-1)], na.rm = T) %>% round )
    i = j + 1
  }
  
  signals[[var]] = impl.signals
  
  ## displaying. ------------------------------------------
  print( paste( round(var/length(vars)*100, 0), " %", sep = "" ) )
}
```




## Peak definition and annotation

```{r}
peak.annotation = list()
cand = list()
cand2 = list()

for( var in seq_along(vars) )
{
  # computing the peak limits. ------------------
  peaklimit = array(NA, c( length(signals[[var]]), 2 ) )
  for( i in seq_along(signals[[var]]) )
  {
    peaklimit[i, 1] = 
      which( liss[,var] == 0 & 
               seq_along(liss[,var]) < signals[[var]][i] ) %>% max
    peaklimit[i, 2] = 
      which( liss[,var] == 0 & 
               seq_along(liss[,var]) > signals[[var]][i] ) %>% min
  }
  
  # annotating the peaks. -----------------------
  .peak.annotation = matrix( NA, nrow(peaklimit), 8 )
  intervals  = c()
  intervals2 = c()
  for( i in 1:nrow(peaklimit) )
  {
    interval = peaklimit[i,1]:peaklimit[i,2]
    tmp.data = dataf2[interval, 4+var] %>% pull
    
    .peak.annotation[i,1] = 
      ifelse( type == "BF" || type == "Z", 
              max( tmp.data ), min( tmp.data ) )
    
    .peak.annotation[i,2] = 
      ifelse(
        type == "BF" || type == "Z",
        interval[ which.max(tmp.data) ],
        interval[ which.min(tmp.data) ] 
        )
    
    .peak.annotation[i,3] = min(interval)
    .peak.annotation[i,4] = max(interval)
    .peak.annotation[i,5] = max(interval) - min(interval)
    
    # qpeak = case_when(
    #   type == "BF" ~ which( log10(tmp.data) > quantile( log10(tmp.data), p = proba) ),
    #   type == "Pval" ~ which( -log10(tmp.data) > quantile( -log10(tmp.data), p = proba ) )
    # )
    
    .peak.annotation[i,6] = NA # length( qpeak )
    .peak.annotation[i,7] = NA
    .peak.annotation[i,8] = NA # dataf2 %>% filter( ID %in% list.sign[,var] ) %>% nrow()
    
    intervals = c( intervals, peaklimit %>% t %>% c)
    # if( dataf2 %>% slice(interval) %>% filter( ID %in% list.sign[,var] ) %>% nrow() > 0 )
      intervals2 = c(intervals2, peaklimit %>% t %>% c)
  }
  
  colnames( .peak.annotation ) = c("Min", "Pos", "Start", "End", "Wide", "SNPs", "Scaff", "Sign" )
  rownames( .peak.annotation ) = 
    dataf2 %>% slice( .peak.annotation[,2] ) %>% pull(ID) 

  peak.annotation[[var]] = .peak.annotation
  cand[[var]] = unique(intervals)
  cand2[[var]] = unique(intervals2)
}
```




## List, Stat files and plots

```{r}

gg_color_hue = function(n) 
{
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n    = 12
cols = gg_color_hue(n)
peakheight = 5

if( type == "BF" || type == "Z" )
{
  for( var in seq_along(vars) )
  {
    stats = peak.annotation[[var]]
    if(length(stats)==0)
    {
      # do nothing.
    } else {
      write.table(
        stats,
        paste( "stat/peak.", extens, ".", colnames(dataf2)[[4+var]], ".", proba, ".txt", sep = "" ),
        col.names = T, row.names = T, quote = F, sep = "\t" )
      
      cut  = proba
      temp = dataf2[cand[[var]],]
      
      list.peak = temp$ID[which(temp[,4+var] > cut)]
      list_scaff.peak = unique(temp$Scaff[which(temp[,4+var] > cut)])
      
      write.table(
        list.peak,
        paste( "stat/list.snp.peak.", extens, colnames(dataf2)[4+var], ".", proba, ".txt", sep = "" ),
        col.names = F, row.names = F, quote = F, sep = "\t" )
      
      write.table(
        list_scaff.peak,
        paste( "stat/list.scaff.peak.", extens, colnames(dataf2)[4+var], ".", proba, ".txt", sep = "" ),
        col.names = F, row.names = F, quote = F, sep = "\t" )
      
      
      pdf(
        paste( "plot/", extens, colnames(dataf2)[4+var], ".", proba, ".BF.pdf", sep = "" ),
        width = 10, height = 8 )
      layout( matrix(c(1,1,1,2,3,3), nrow = 2, byrow = T ) )
      
      plot( log10(dataf2[,4+var] %>% pull),
            main = colnames(dataf2)[4+var],
            col  = cols[factor(dataf2$LG)],
            ylab = "XtX",
            las  = 1
            )
      
      peakheight = ((max(log10(peak.annotation[[var]][,1]))-min(log10(peak.annotation[[var]][,1])))*0.25) / max(liss[,var], na.rm = T)
      
      points(
        liss[,var] * peakheight + min(log10(dataf2[,4+run])),
        type = "l", col = "gray35" )
      abline( v = c(peak.annotation[[var]][which(peak.annotation[[var]][,8] > 0),2]), lty = 4, col = "gray45")
      
      hist( dataf2[,4+var] %>% pull, freq = F,
            xlab = colnames(dataf2)[4+var],
            las = 1,
            main = "",
            col = "white", 
            border = "white" )
      lines( density(dataf2[,4+var] %>% pull), col = "gray35", lwd = 2 )
      abline( v = proba, lty = 3, col = "red" )
      
      plot(
        log10(sample(dataf2[,4+var] %>% pull,replace=F)),
        col = cols[factor(dataf2$LG)],
        ylab = "XtX",
        main = "random")
      
      dev.off()
    }
  }
  
  
} else {
  
  E = sort(-log10(runif(nrow(dataf2),0,1)))
  
  for(i in vars)
  {
    run = run + 1
    stats = sortie5[[run]]
    
    if( length(stats) == 0)
    {
      # do nothing. 
    } else {
      write.table(
        stats,
        paste("stat/peak.", extens, ".", colnames(dataf2)[[4+var]], ".", proba, ".txt", sep = "" ),
        col.names = T, row.names = T, quote = F, sep = "\t" )
      
      cut = max(dataf2[which(qvalue(dataf2[,4+var])$qvalue < 0.1), 4+var])
      
      temp  = dataf2[cand[[var]],]
      temp2 = dataf2[cand2[[var]],]
      list.peak = temp$ID[which(temp[,4+var] < cut)]
      list_scaff.peak = unique(temp$Scaff[which(temp[,4+var] < cut)])
      list.peak.test  = temp2$ID
      list_scaff.peak.test = unique(temp2$Scaff)
      
      write.table(
        list.peak,
        paste( "stat/list.snp.peak.", extens, colnames(dataf2)[4+var], ".", proba, ".txt", sep = "" ),
        col.names = F, row.names = F, quote = F, sep = "\t" )
      
      write.table(
        list_scaff.peak,
        paste( "stat/list.scaff.peak.", extens, colnames(dataf2)[4+var], ".", proba, ".txt", sep = "" ),
        col.names = F, row.names = F, quote = F, sep = "\t" )
      
      write.table(
        list_scaff.peak.test,
        paste( "stat/list.scaff.peak.test.", extens, colnames(dataf2)[4+var], ".", proba, ".txt", sep = "" ),
        col.names = F, row.names = F, quote = F, sep="\t" )
      
      write.table(
        test,
        paste( "stat/random835.test.", extens, colnames(dataf2)[4+var], ".", proba, ".txt", sep = "" ),
        col.names = F, row.names = F, quote = F, sep = "\t" )
      
      pdf(
        paste( "plot/", extens, ".", colnames(dataf2)[4+var], ".", proba, ".qval.pdf", sep = "" ),
        width = 10, height = 8 )
      layout( matrix(c(1,1,1,2,3,3), nrow = 2, byrow = T ) )
      
      plot(
        -log10(dataf2[,4+var] %>% pull),
        main = colnames(dataf2)[4+var],
        col  = cols[factor(dataf2$LG)],
        ylab = "-log10(p.values)",
        las  = 1
        )
      
      peakheight = (max(-log10(peak.annotation[[var]][,1]))*0.25)/max(liss[,var],na.rm=T)
      points( liss[,var]*peakheight,
              type = "l", col = "gray45" )
      
      abline( v = c(peak.annotation[[var]][which(peak.annotation[[var]][,8] > 0),2]), lty = 4, col = "gray45" )
      P = sort(-log10(dataf2[,4+var] %>% pull))
      
      plot( P~E,
            xlab = "Expected p.values",
            las = 1,
            ylab = "Observed p.values" )
      
      A = seq(0,max(E),0.1)
      points(A, A, type = "l", col = "red" )
      
      plot( -log10(sample(dataf2[,4+var] %>% pull,replace=F)),
            col = cols[factor(dataf2$LG)],
            ylab = "-log10(p.values)",
            main = "random"
            )
      dev.off()
    }
  }
}


out2 = matrix(NA,length(vars),2)
for( i in seq_along(vars) )
{
  run = run+1
  out = c(nrow(peak.annotation[[var]]),
          nrow(peak.annotation[[var]][which(peak.annotation[[var]][,8] >0),]))
  out2[var,] = out
}

rownames(out2) = colnames(dataf2)[5:(4+length(vars))]
colnames(out2) = c("Peaks","Peaks.Sign")

write.table(
  out2,
  paste("Bilan.peaks.", extens, ".txt", sep = "" ),
  col.names = T, row.names = T, quote = T, sep = "\t" )

```

















